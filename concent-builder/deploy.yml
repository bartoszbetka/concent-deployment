- hosts:
    - concent-builder
  vars_files:
    - consts.yml
    - "{{ deployment_values }}"
  tasks:
    - become:      yes
      become_user: "{{ shared_user }}"
      block:
        - name: Configure kubectl to operate on the right cluster
          command: gcloud container clusters get-credentials \
              "{{ gke.cluster }}"                            \
              --project "{{ gke.project }}"                  \
              --zone    "{{ gke.zone }}"

        - name:    Clear the cluster
          command: "{{ build_dir}}/concent-deployment/kubernetes/build/delete-services.sh"
          args:
            chdir: "{{ build_dir}}/concent-deployment/kubernetes/build/"

        - name:    Push docker images to GKE
          command: "{{ build_dir}}/concent-deployment/kubernetes/build/push-docker-images.sh"
          args:
            chdir: "{{ build_dir }}/concent-deployment/kubernetes/build/"

        - name:    Deploy containers to the cluster
          command: "{{ build_dir}}/concent-deployment/kubernetes/build/create-services.sh"
          args:
            chdir: "{{ build_dir}}/concent-deployment/kubernetes/build/"
